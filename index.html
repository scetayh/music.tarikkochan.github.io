<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>music.tarikkochan.top</title>
  <style>
    /* 简单布局：不美化，优先功能 */
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 1rem; }
    #controls { display:flex; gap:0.5rem; align-items:center; margin-bottom: 1rem; }
    #playlistButtons { display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem; }
    button.playlist-btn { padding:0.4rem 0.6rem; cursor:pointer; }
    #main { display:flex; gap:1rem; align-items:flex-start; }
    #songList { min-width:280px; max-height:480px; overflow:auto; border:1px solid #ddd; padding:0.5rem; }
    #songList li { list-style:none; padding:0.4rem; cursor:pointer; border-bottom:1px solid #f4f4f4; }
    #songList li:hover { background:#f7f7f7; }
    #songList li .artist { color:#666; font-size:0.85rem; }
    #info { flex:1; border:1px solid #ddd; padding:0.5rem; max-height:480px; overflow:auto }
    #lyrics { white-space:pre-wrap; font-size:0.95rem; }
    .lyric-line { padding:0.2rem; border-radius:3px; }
    .lyric-line.current { background: #fffae6; }
    .bilingual .orig { font-weight:600 }
    .cover { width:120px; height:120px; object-fit:cover; border:1px solid #ddd; }
    #player { display:inline-block; }

    hidden {display: none; }
  </style>
</head>
<body>
  <h2>music.tarikkochan.top（基于NyxerPlayer）</h2>

  <p>
    在点按 <strong>播放 / 暂停</strong> 按钮后，请耐心等待 10 秒左右。
  </p>

  <div id="controls">
    <span style="position: absolute; left: -9999px;">
      <button id="showBtn"></button>
    </span>
    <button id="playBtn">播放 / 暂停</button>
    <div id="player" style="display:inline-block"></div>
  </div>

  <div id="playlistButtons" aria-label="歌单选择">少女祈祷中...</div>

  <div id="main">
    <ul id="songList" aria-label="歌曲列表">选择歌单</ul>

    <div id="info">
      <div style="display:flex;gap:1rem;margin-bottom:1rem;align-items:center">
        <img id="cover" class="cover" src="" alt="专辑封面" />
        <div>
          <div id="currentTitle" style="font-weight:600"></div>
          <div id="currentArtist" style="color:#666"></div>
        </div>
      </div>

      <!-- <h4>完整歌词（如有）</h4> -->
      <div id="lyrics">暂无歌词</div>
    </div>
  </div>

  <script type="module">
    import { initPlayer } from 'https://esm.sh/nyx-player'

    const METING_API = 'https://api.injahow.cn/meting/'

    // 解析 playlist url，和 package 中 PlayList.parserURL 的逻辑一致
    function parseAccessibleURL(url) {
      const rules = [
        [/music.163.com.*song.*id=(\d+)/, 'netease', 'song'],
        [/music.163.com.*album.*id=(\d+)/, 'netease', 'album'],
        [/music.163.com.*artist.*id=(\d+)/, 'netease', 'artist'],
        [/music.163.com.*playlist.*id=(\d+)/, 'netease', 'playlist'],
        [/music.163.com.*discover\/toplist.*id=(\d+)/, 'netease', 'playlist'],
        [/y.qq.com.*song\/(\w+)(.html)?/, 'tencent', 'song'],
        [/y.qq.com.*album\/(\w+)(.html)?/, 'tencent', 'album'],
        [/y.qq.com.*singer\/(\w+)(.html)?/, 'tencent', 'artist'],
        [/y.qq.com.*playsquare\/(\w+)(.html)?/, 'tencent', 'playlist'],
        [/y.qq.com.*playlist\/(\w+)(.html)?/, 'tencent', 'playlist']
      ]
      for (const [patt, provider, type] of rules) {
        const res = patt.exec(url)
        if (res && res[1]) {
          return { id: res[1], provider, type }
        }
      }
      throw new Error('Unsupported URL: ' + url)
    }

    async function fetchPlaylist(url) {
      const acc = parseAccessibleURL(url)
      const res = await fetch(`${METING_API}?type=${acc.type}&id=${acc.id}&server=${acc.provider}`)
      const json = await res.json()
      return json // array of songs according to METING API
    }

    // LRC 解析（借鉴 nyx-player 的实现）
    function parseLyricLineTime(line) {
      const timePattern = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/
      const match = timePattern.exec(line)
      if (!match) return null
      const min = parseInt(match[1], 10) * 60
      const sec = parseInt(match[2], 10)
      const msecStr = match[3]
      let msec = 0
      if (msecStr) {
        if (msecStr.length === 2) msec = parseInt(msecStr, 10) / 100
        else msec = parseInt(msecStr, 10) / 1000
      }
      return min + sec + msec
    }

    function parseLRCContent(content) {
      const lines = content.split('\n').filter(Boolean)
      const parsed = []
      for (const line of lines) {
        const t = parseLyricLineTime(line)
        if (t === null) continue
        const bracketEnd = line.indexOf(']')
        const text = bracketEnd !== -1 ? line.substring(bracketEnd + 1).trim() : line.trim()
        parsed.push({ start: t, text })
      }
      // build groups by start time to support bilingual (same timestamp multiple lines)
      const groups = []
      parsed.sort((a,b)=>a.start-b.start)
      for (let i=0;i<parsed.length;i++){
        const s = parsed[i].start
        const texts = [parsed[i].text]
        let j = i+1
        while (j<parsed.length && parsed[j].start === s) {
          texts.push(parsed[j].text); j++
        }
        const end = j < parsed.length ? parsed[j].start : Infinity
        groups.push({ start: s, end, texts })
        i = j-1
      }
      return groups
    }

    // UI elements
    const playlistButtonsEl = document.getElementById('playlistButtons')
    const songListEl = document.getElementById('songList')
    const lyricsEl = document.getElementById('lyrics')
    const coverEl = document.getElementById('cover')
    const currentTitleEl = document.getElementById('currentTitle')
    const currentArtistEl = document.getElementById('currentArtist')

    let playlists = []

    // 加载 JSON
    async function loadPlaylists() {
      const res = await fetch('/playlists.json')
      playlists = await res.json()
      playlistButtonsEl.innerHTML = ''
      playlists.forEach((pl, idx) => {
        const btn = document.createElement('button')
        btn.textContent = pl.name
        btn.className = 'playlist-btn'
        btn.addEventListener('click', () => switchToPlaylist(idx))
        playlistButtonsEl.appendChild(btn)
      })

      // 初始化 nyx-player，传入所有 URL（用于标签和内部切换）
      const urls = playlists.map(p => ({ url: p.url, name: p.name }))
      initPlayer('#player', '#showBtn', urls, '#playBtn')

      // 为了首次显示第一个歌单的歌曲（如果页面需要），模拟点击第一个
      if (playlists.length > 0) {
        await switchToPlaylist(0)
      }
    }

    // 通过模拟点击内部的 tab 切换歌单，并在页面外列出歌曲
    async function switchToPlaylist(index) {
      // try to click the inside tab in nyx-player
      const tabLi = document.querySelector(`.tabs .nav li[data-index="${index}"]`)
      if (tabLi) tabLi.click()

      // fetch playlist data and render list
      songListEl.innerHTML = '少女祈祷中...'
      try {
        const songs = await fetchPlaylist(playlists[index].url)
        // sort — 这里默认按返回顺序，如果需要按名称排序可提供交互
        renderSongList(songs, index)
      }
      catch (e) {
        songListEl.innerHTML = '加载歌单失败：' + e.message
      }
    }

    // render songs
    function renderSongList(songs, playlistIndex) {
      songListEl.innerHTML = ''
      songs.forEach((song, i) => {
        const li = document.createElement('li')
        li.dataset.index = i
        li.innerHTML = `<div class="song-name">${song.name}</div><div class="artist">${song.artist}</div>`
        li.addEventListener('click', () => {
          // 点击时，找到对应的内部 li 并触发
          const internalList = document.querySelectorAll('.playlist ol')[playlistIndex]
          if (internalList) {
            const internalLi = internalList.querySelectorAll('li')[i]
            if (internalLi) internalLi.click()
          }
          // 显示歌词与封面
          showSongDetail(song)
        })
        songListEl.appendChild(li)
      })
    }

    // show current song info, fetch lyric and show
    let currentLyricGroups = []
    function showSongDetail(song) {
      currentTitleEl.textContent = song.name || ''
      currentArtistEl.textContent = song.artist || ''
      // cover
      if (song.pic) coverEl.src = song.pic
      else coverEl.src = ''

      // lyric fetch & render
      const lrcUrl = typeof song.lrc === 'string' ? song.lrc : (song.lrc && song.lrc.lyric ? song.lrc.lyric : '')
      if (!lrcUrl) {
        lyricsEl.textContent = '暂无歌词'
        currentLyricGroups = []
        return
      }
      fetch(lrcUrl).then(r => r.text()).then(text => {
        currentLyricGroups = parseLRCContent(text)
        renderLyrics(currentLyricGroups)
      }).catch(err => {
        lyricsEl.textContent = '获取歌词失败'
        currentLyricGroups = []
      })
    }

    function renderLyrics(groups) {
      if (!groups || groups.length === 0) {
        lyricsEl.textContent = '暂无歌词'
        return
      }
      lyricsEl.innerHTML = ''
      groups.forEach((g, idx) => {
        const d = document.createElement('div')
        d.className = 'lyric-line'
        d.dataset.start = g.start
        d.dataset.end = g.end
        if (g.texts.length === 1) {
          d.textContent = g.texts[0]
        }
        else {
          // bilingual
          d.classList.add('bilingual')
          const orig = document.createElement('div')
          orig.className = 'orig'
          orig.textContent = g.texts[0]
          const trans = document.createElement('div')
          trans.className = 'translate'
          trans.textContent = g.texts.slice(1).join(' / ')
          d.appendChild(orig)
          d.appendChild(trans)
        }
        lyricsEl.appendChild(d)
      })
    }

    // sync highlighting with the player's audio element
    function setupAudioSync() {
      const audio = document.querySelector('#MusicPlayerRoot audio')
      if (!audio) return
      let lastIdx = -1
      audio.addEventListener('timeupdate', () => {
        const time = audio.currentTime
        // find current index
        let idx = -1
        for (let i = 0; i < currentLyricGroups.length; i++) {
          const g = currentLyricGroups[i]
          if (time >= g.start && time <= g.end) { idx = i; break }
        }
        if (idx !== lastIdx) {
          lastIdx = idx
          // remove previous
          const all = lyricsEl.querySelectorAll('.lyric-line')
          all.forEach(el => el.classList.remove('current'))
          if (idx !== -1) {
            const cur = all[idx]
            if (cur) {
              cur.classList.add('current')
              // scroll into view
              cur.scrollIntoView({ block: 'center', behavior: 'smooth' })
            }
          }
        }
      })
    }


    // 拦截全局的播放事件来更新详情视图（当内置播放器切歌时）
    // 监听 mutation 当 song 变化时更新 info
    function watchPlayerSongChange() {
      // 手动轮询当前 song info 顶层区域
      setInterval(() => {
        // 打开 AudioInfo 中的 title 与 artist DOM
        const titleEl = document.querySelector('.preview h4')
        const artistEl = document.querySelector('.preview span')
        if (titleEl && artistEl) {
          const t = titleEl.textContent || ''
          const a = artistEl.textContent || ''
          currentTitleEl.textContent = t
          currentArtistEl.textContent = a
        }
        // cover
        const coverImg = document.querySelector('.cover img')
        if (coverImg && coverImg.getAttribute('src')) {
          coverEl.src = coverImg.getAttribute('src')
        }

        // setup audio sync whenever audio exists
        setupAudioSync()
      }, 800)
    }

    // 初始化
    loadPlaylists()
    watchPlayerSongChange()
  </script>
</body>
</html>